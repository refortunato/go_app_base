ARG GO_VERSION=1.25.5
FROM golang:${GO_VERSION}-alpine3.23

WORKDIR /app

# Instala Air (cacheable, não muda frequentemente)
RUN go install github.com/air-verse/air@latest

# Copia apenas arquivos de dependências (camada cacheable)
COPY go.mod go.sum ./

# Download das dependências (cacheable até go.mod/go.sum mudarem)
RUN go mod download

# Install bash and netcat for the wait-for-mysql script
RUN apk add --no-cache bash netcat-openbsd || true

# Copy .docker scripts into image (will be overwritten by bind mount in development)
COPY ./.docker /app/.docker
RUN chmod +x /app/.docker/wait-for-mysql.sh || true

EXPOSE 8080

# Entrypoint: wait for MySQL, then exec the CMD
ENTRYPOINT ["/bin/sh", "-c", "/app/.docker/wait-for-mysql.sh mysql 3306 60; exec \"$@\"", "--"]

# Air passes arguments after -- to the application
# Default: api
CMD [ "air", "-c", ".air.toml", "--", "api" ]
